name: PR Policy & Quality Checks

on:
  pull_request:
    types: [opened, synchronize, reopened]
    branches: [main, dev]

jobs:
  code-quality:
    name: Code Quality Checks
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Check for large files
        run: |
          find . -type f -size +5M -not -path "./.git/*" -not -path "./node_modules/*" -not -path "./frontend/node_modules/*" | head -10

      - name: Check for secrets
        uses: trufflesecurity/trufflehog@main
        with:
          base: main
          head: HEAD

      - name: Frontend dependency audit
        working-directory: ./frontend
        run: npm audit --audit-level moderate

      - name: Validate configuration files
        run: |
          if [ -f "frontend/.env.example" ]; then
            echo "✅ .env.example exists"
          else
            echo "❌ .env.example missing"
            exit 1
          fi

  pr-validation:
    name: PR Validation
    runs-on: ubuntu-latest
    needs: [code-quality]

    steps:
      - uses: actions/checkout@v4

      - name: Validate PR metadata
        uses: actions/github-script@v7
        with:
          script: |
            const { data: pr } = await github.rest.pulls.get({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: context.issue.number
            });

            if (!pr.body || pr.body.length < 50) {
              core.setFailed('PR description must be at least 50 characters');
              return;
            }

            const titlePattern = /^(feat|fix|docs|style|refactor|test|chore)(\(.+\))?: .+/;
            if (!titlePattern.test(pr.title)) {
              core.setFailed('PR title must follow conventional commit format');
              return;
            }

            console.log('PR validation passed');